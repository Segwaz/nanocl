Type: Deployment
ApiVersion: v0.3

Namespace: system

Resources:
- Name: ProxyRule
  Kind: Custom
  Version: v0.1
  Config:
    $schema: http://json-schema.org/draft-07/schema#
    title: ResourceProxyRule
    description: Define proxy rules to apply
    type: object
    required:
    - Rule
    - Watch
    properties:
      Rule:
        description: The rule
        allOf:
        - $ref: '#/definitions/ProxyRule'
      Watch:
        description: Cargo to watch for changes
        type: array
        items:
          type: string
    definitions:
      CargoTarget:
        description: Defines a proxy rule target
        type: object
        required:
        - Key
        - Port
        properties:
          Key:
            description: The cargo key
            type: string
          Port:
            description: The cargo port
            type: integer
            format: uint16
            minimum: 0.0
      HttpTarget:
        type: object
        required:
        - Url
        properties:
          Redirect:
            anyOf:
            - $ref: '#/definitions/UrlRedirect'
            - type: 'null'
          Url:
            type: string
      LocationTarget:
        oneOf:
        - type: object
          required:
          - Cargo
          properties:
            Cargo:
              $ref: '#/definitions/CargoTarget'
          additionalProperties: false
        - type: object
          required:
          - Http
          properties:
            Http:
              $ref: '#/definitions/HttpTarget'
          additionalProperties: false
      ProxyHttpLocation:
        description: Defines a proxy rule location
        type: object
        required:
        - Path
        - Target
        properties:
          Path:
            description: The path
            type: string
          Target:
            description: The target cargo
            allOf:
            - $ref: '#/definitions/LocationTarget'
      ProxyRule:
        description: Proxy rules modes
        oneOf:
        - description: Redirect http trafic
          type: object
          required:
          - Http
          properties:
            Http:
              $ref: '#/definitions/ProxyRuleHttp'
          additionalProperties: false
        - description: Redirect tcp and udp trafic
          type: object
          required:
          - Stream
          properties:
            Stream:
              $ref: '#/definitions/ProxyRuleStream'
          additionalProperties: false
      ProxyRuleHttp:
        description: Defines a proxy rule http config
        type: object
        required:
        - Locations
        - Network
        properties:
          Domain:
            description: The domain
            type:
            - string
            - 'null'
          Includes:
            description: Path to extra config file to include
            type:
            - array
            - 'null'
            items:
              type: string
          Locations:
            description: The locations to handle multiple paths
            type: array
            items:
              $ref: '#/definitions/ProxyHttpLocation'
          Network:
            description: Type of private | public | internal | namespace:$namespace_name
            type: string
          Ssl:
            description: The ssl configuration
            anyOf:
            - $ref: '#/definitions/ProxySslConfig'
            - type: 'null'
      ProxyRuleStream:
        description: Proxy rules modes
        type: object
        required:
        - Network
        - Port
        - Protocol
        - Target
        properties:
          Network:
            description: Type of the network binding private | public | internal | namespace:$namespace_name
            type: string
          Port:
            description: The port to open on nodes
            type: integer
            format: uint16
            minimum: 0.0
          Protocol:
            description: Protocol to use Tcp | Udp
            allOf:
            - $ref: '#/definitions/ProxyStreamProtocol'
          Ssl:
            description: The ssl configuration
            anyOf:
            - $ref: '#/definitions/ProxySslConfig'
            - type: 'null'
          Target:
            description: The target cargo
            allOf:
            - $ref: '#/definitions/CargoTarget'
      ProxySslConfig:
        type: object
        required:
        - Certificate
        - CertificateKey
        properties:
          Certificate:
            description: Path to the certificate
            type: string
          CertificateKey:
            description: Path to the certificate key
            type: string
          DhParam:
            description: Path to the dhparam file
            type:
            - string
            - 'null'
      ProxyStreamProtocol:
        description: Proxy rules modes
        type: string
        enum:
        - Tcp
        - Udp
      UrlRedirect:
        type: string
        enum:
        - MovedPermanently
        - PermanentRedirect
        - TemporaryRedirect

Cargoes:
- Name: proxy
  Container:
    Image: nexthat/nanocl-proxy:0.2.3
    HostConfig:
      NetworkMode: host
      Binds: [
        "/var/lib/nanocl/proxy/letsencrypt:/etc/letsencrypt",
        "/var/lib/nanocl/proxy/conf.d:/etc/nginx/conf.d",
        "/var/lib/nanocl/proxy/html:/usr/share/nginx/html",
        "/var/lib/nanocl/proxy/sites-enabled:/etc/nginx/sites-enabled",
        "/var/lib/nanocl/proxy/streams-enabled:/etc/nginx/streams-enabled",
      ]

- Name: ctrl-proxy
  Container:
    Image: nexthat/nanocl-ctrl-proxy:0.2.3
    HostConfig:
      Binds: [
        "/var/lib/nanocl/proxy/conf.d:/etc/nginx/conf.d",
        "/var/lib/nanocl/proxy/sites-enabled:/etc/nginx/sites-enabled",
        "/var/lib/nanocl/proxy/streams-enabled:/etc/nginx/streams-enabled",
        "/run/nanocl:/run/nanocl"
      ]
