# [nanocl/Deployment] $ nanocl state apply -f examples/minio.yml
ApiVersion: v0.6
Kind: Deployment

Args:
  - Name: namespace
    Type: String
  - Name: domain
    Type: String

Namespace: ${{ Args.namespace }}

Cargoes:
  - Name: s3
    Container:
      Image: minio/minio:latest
      Env:
        - MINIO_BROWSER_REDIRECT_URL=http://console.s3.${{ Args.domain }}
        - MINIO_SERVER_URL=http://s3.${{ Args.domain }}
      HostConfig:
        Dns:
          - ${{ Namespaces[Args.namespace].Gateway }}
          - 1.1.1.1
        Binds:
          - /opt/s3/data:/data
      Cmd:
        - server
        - /data
        - --console-address
        - :9001

Resources:
  # Dns Rule for our namespace
  - Name: dns-${{ Args.namespace }}
    Kind: DnsRule
    Version: v0.1
    Config:
      Network: ${{ Args.namespace }}.nsp
      Entries:
        - Name: s3.${{ Args.domain }}
          IpAddress: ${{ Args.namespace }}.nsp
        - Name: console.s3.${{ Args.domain }}
          IpAddress: ${{ Args.namespace }}.nsp

  # Proxy Rule for our namespace
  - Name: ${{ Args.domain }}
    Kind: ProxyRule
    Version: v0.4
    Config:
      Watch:
        - s3.${{ Args.namespace }}
      Rules:
        - Domain: s3.${{ Args.domain }}
          Network: ${{ Args.namespace }}.nsp
          Locations:
            - Path: /
              Target:
                CargoKey: s3.${{ Args.namespace }}
                CargoPort: 9000

        - Domain: console.s3.${{ Args.domain }}
          Network: ${{ Args.namespace }}.nsp
          Locations:
            - Path: /
              Version: 1.1
              Headers:
                - Upgrade $http_upgrade
                - Connection "Upgrade"
              Target:
                CargoKey: s3.${{ Args.namespace }}
                CargoPort: 9001
